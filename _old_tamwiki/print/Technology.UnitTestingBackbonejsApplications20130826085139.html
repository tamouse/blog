<!DOCTYPE html>
<html><head>
  <title>TamWiki | Technology / Unit Testing Backbone.js Applications</title>
  <link rel='stylesheet' href='http://wiki.tamouse.org/pub/skins/print/print.css' type='text/css' />
</head>
<body>
<!--PageText-->
<div id='wikitext'>
<h1>Unit Testing Backbone.js Applications</h1>
<p><a class='external' href='http://www.sitepoint.com/author/sthomas/' target='_blank'>Stephen Thomas</a>
</p>
<p class='vspace'>Published February 25, 2013
</p>
<p class='vspace'>After spending hours, maybe <em>days</em>, putting the finishing touches on an awesome new feature for your web application, you&rsquo;re finally ready to see it in action. You add the new code to your <span class='wikiword'>JavaScript</span> base, build the release candidate, and fire up your browser, expecting to be amazed. Then &hellip; Uh Oh&hellip; the new feature may be working fine, but some other critical part of your app &ndash; a part you didn&rsquo;t <em>touch</em> while developing the new version &ndash; has gone horribly awry. Now you&rsquo;re faced with the challenge of backtracking through days of work to try and figure out how you broke the existing code. Happy days are definitely not here again.
</p>
<p class='vspace'>That very scenario has bitten me more than I&rsquo;d like to admit. And if you&rsquo;ve been coding awhile, you&rsquo;ve probably seen it as well. Consider, though, what makes this scenario so painful. It isn&rsquo;t really because our new code broke existing code; that&rsquo;s inevitable in development. The real pain is that it took so long to notice the breakage. With so much development since we knew our application was working, there&rsquo;s a vast amount of code in which the bug may be hiding. And, though it may seem a bit like hunting for a needle in a haystack, we have no choice but to dive it.
</p>
<p class='vspace'>In this article we are truly going to banish this scenario from our <span class='wikiword'>JavaScript</span> development. No more digging through hours, days, or weeks of code looking for a needle. The principle we&rsquo;ll adopt is a simple one: find any bug <em>as soon as</em> we create it. That&rsquo;s right; we&rsquo;re going to set up a development environment and process that tells us immediately when we write code that introduces a bug. Furthermore, the extra effort we put into the process won&rsquo;t go to waste once initial development is complete. The same test code that catches our development bugs will be completely reusable in an integration environment. We can easily incorporate the tests into our source code managements system, blocking bugs before they can even get into our code base.
</p>
<p class='vspace'>In the four sections that follow, we&rsquo;ll first look at the tools we need for a <span class='wikiword'>JavaScript</span> testing environment. We&rsquo;ll then consider a trivial application, one that&rsquo;s simple enough to understand, yet has all the features and functionality that might exist in a real production web application. The final two sections demonstrate how we can use our environment to test the example app during development and, once initial development is complete, during integration.
</p>
<div class='vspace'></div><h2>Assembling a <span class='wikiword'>JavaScript</span> Testing Environment</h2>
<p>Our unit testing nirvana requires some development tools that may not be in your workbench (yet). The news, both good and bad, is that there are options aplenty. That&rsquo;s good news because it gives us options, and that&rsquo;s bad news because the pace of front end development today means that there are far too many options. To focus our evaluation, let&rsquo;s be explicit about our top two goals. Everything else is secondary:
</p>
<div class='vspace'></div><ol><li>Our environment must support frictionless, continuous testing during development.
</li><li>Tests created during development must be equally usable in integration.
</li></ol><div class='vspace'></div><h3>Execution Environments</h3>
<p>For <span class='wikiword'>JavaScript</span> coding, there is no better development environment than the modern web browser. Whether your taste is Firebug or Webkit&rsquo;s Developer Tools, the browser supports live DOM inspection and editing, full interactive debugging, and sophisticated performance analysis. Web browsers are great for development, and so our test tools and environment must integrate with in-browser development. Web browsers, however, are not so great for integration testing. Integration testing often takes places on servers somewhere in the cloud (or a least somewhere in the data center). Those systems don&rsquo;t even have a graphical user interface, much less a modern web browser. For efficient integration testing, we need simple command line scripts and a <span class='wikiword'>JavaScript</span> execution environment that supports them. For those requirements, the tool of choice is <a class='external' href='http://nodejs.org' target='_blank'>node.js</a>. Although there are other command line <span class='wikiword'>JavaScript</span> environments, none has the breadth and depth of support to match node.js. In the integration phase, our test tools must integrate with node.js.
</p>
<div class='vspace'></div><h3>Test Framework</h3>
<p>Now that we&rsquo;ve established that our test tools must support both web browser and node.js environments, we can narrow the choices enough to select a core test framework. Many <span class='wikiword'>JavaScript</span> test frameworks exist, but most are heavily biased towards browser testing; getting them working with node.js is usually possible, but often requires inelegant hacks or tweaks. One framework that does not suffer from this problem is <a class='external' href='http://visionmedia.github.com/mocha/' target='_blank'>Mocha</a>, which justifiably describes itself as:
</p>
<div class='vspace'></div><div class='indent'>Mocha is a feature-rich <span class='wikiword'>JavaScript</span> test framework running on node and the browser, making asynchronous testing simple and fun.
</div><p class='vspace'>Originally developed for node.js, Mocha has been extended to readily support web browsers as well. By using Mocha as our test framework, we can write tests that support both development and integration without modification.
</p>
<div class='vspace'></div><h3>Assertion Library</h3>
<p>Unlike some <span class='wikiword'>JavaScript</span> test frameworks, Mocha was designed for maximum flexibility. As a consequence, we&rsquo;ll have to choose a few additional pieces to make it complete. In particular, we need a <span class='wikiword'>JavaScript</span> assertion library. For that, we&rsquo;ll rely on the <a class='external' href='http://chaijs.com' target='_blank'>Chai Assertion Library</a>. Chai is somewhat unique in that it supports all of the common assertion styles &ndash; <em>assert</em>, <em>expect,</em> and <em>should.</em> Assertion styles determine how we write tests in our test code. Under the covers, they&rsquo;re all equivalent; it&rsquo;s easy to translate tests from one assertion style to the other. The main difference in assertion styles is their readability. The choice of assertion style depends mostly on which style you (or your team) find most readable, and which style produces the most understandable tests. To see the difference, consider developing a trivial test for the following code:
</p>
<div class='vspace'></div><pre> var sum = 2 + 2;
</pre><p class='vspace'>A traditional, assert-style test could be written as:
</p>
<div class='vspace'></div><pre> assert.equal(sum, 4, "sum should equal 4");
</pre><p class='vspace'>That test gets the job done, but unless you&rsquo;ve grown accustomed to old-school unit testing, it&rsquo;s probably a little challenging to read and interpret. An alternative assertion style uses <code>expect</code>:
</p>
<div class='vspace'></div><pre> expect(sum).to.equal(4);
</pre><p class='vspace'>Most developers find expect-style assertions easier to read and understand than assert-style tests. The third alternative, <code>should</code>, makes test assertions even more like natural language:
</p>
<div class='vspace'></div><pre> sum.should.equal(4);
</pre><p class='vspace'>The Chai library supports all three assertion styles. In this article we&rsquo;ll stick with <code>should</code>.
</p>
<div class='vspace'></div><h3>Spies, Stubs, and Mocks</h3>
<p>Most web apps, including the trivial example we&rsquo;ll consider in this article, rely on third party libraries and services. In many cases, testing our code will require observing &ndash; or even controlling &ndash; those libraries and services. The <a class='external' href='http://sinonjs.org' target='_blank'>Sinon.JS</a> library provides a lot of tools for testing those interactions. Such tools fall into three general classes:
</p>
<div class='vspace'></div><ul><li><strong><em>Spy</em></strong>. Test code that observes calls to functions outside of the code under test. Spies do not interfere with the operation of those external functions; they merely record the invocation and return value.
</li><li><strong><em>Stub</em></strong>. Test code that stands in for calls to functions outside of the code under test. The stub code doesn&rsquo;t attempt to replicate the external function; it simply prevents unresolved errors when the code under test accesses the external function.
</li><li><strong><em>Mock</em></strong>. Test code that mimics functions or services outside of the code under test. With mocks, test code can specify the return values from those functions or services so it can verify the code&rsquo;s response.
</li></ul><p class='vspace'>Along with the Sinon.JS library itself, we can augment the standard Chai assertion library with <a class='external' href='https://github.com/domenic/sinon-chai' target='_blank'>Sinon.JS Assertions for Chai</a>.
</p>
<div class='vspace'></div><h3>A Unit Test Development Environment</h3>
<p>The final tool for our testing workbench is a development environment for unit testing. For our example we&rsquo;ll use <a class='external' href='https://github.com/airportyh/testem' target='_blank'>Test&rsquo;em</a>. Test&rsquo;em is a collection of handy scripts to set up and run a continuous test environment. We could, if we chose to, write the scripts ourselves and manage the environment manually; however, Toby Ho (Test&rsquo;em&rsquo;s creator) has put together an awesome package that can save us the trouble.
</p>
<div class='vspace'></div><h2>The Example Application</h2>
<p>To see our testing environment in action, let&rsquo;s consider a simple application. Although pared to its bare essentials, this application includes all the functionality required for a real application. (Complete source code for the application is available on <a class='external' href='https://github.com/jsprodotcom/source/blob/master/jsunittest.zip' target='_blank'>GitHub</a>.)
</p>
<div class='vspace'></div><div><img src='http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2013/02/01-jstest-app.png' alt='' title='' /></div>
<p class='vspace'>Users can see their list of todos, and they can click on a check box to toggle any todo&rsquo;s status.
</p>
<div class='vspace'></div><h3>The Todos Database</h3>
<p>Our application starts with a database table that holds the information for todos. Here&rsquo;s the SQL that we could use to create that table.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock1'>
  <div class='sourceblocktext'><div class="sql"><ol><li class="li1"><div class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> <span class="st0">`todos`</span> <span class="br0">&#40;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="st0">`id`</span> &nbsp; &nbsp; &nbsp; <span class="kw1">INT</span><span class="br0">&#40;</span><span class="nu0">11</span><span class="br0">&#41;</span> &nbsp; &nbsp; &nbsp;<span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">AUTO_INCREMENT</span> COMMENT <span class="st0">'Primary key for the table.'</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="st0">`title`</span> &nbsp; &nbsp;<span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">256</span><span class="br0">&#41;</span> <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">DEFAULT</span> <span class="st0">''</span> &nbsp; &nbsp; COMMENT <span class="st0">'The text for the todo item.'</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="st0">`complete`</span> bit<span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span> &nbsp; &nbsp; &nbsp; <span class="kw1">NOT</span> <span class="kw1">NULL</span> <span class="kw1">DEFAULT</span> b<span class="st0">'0'</span> &nbsp; COMMENT <span class="st0">'Boolean indicating whether or not the item is complete.'</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span><span class="st0">`id`</span><span class="br0">&#41;</span> <span class="br0">&#41;</span> ENGINE<span class="sy0">=</span>InnoDB <span class="kw1">DEFAULT</span> CHARSET<span class="sy0">=</span>utf8 COMMENT<span class="sy0">=</span><span class="st0">'To Do items.'</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=1' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>And here&rsquo;s how the table might look after we&rsquo;ve put some test data in it.
</p>
<div class='vspace'></div>
<table ><tr ><th  align='left'>id</th><th  align='left'>title</th><th  align='left'>complete</th></tr>
<tr ><td  align='left'>1</td><td  align='left'>A sample todo item in the database</td><td  align='left'>0</td></tr>
<tr ><td  align='left'>2</td><td  align='left'>Another sample todo item</td><td  align='left'>1</td></tr>
<tr ><td  align='left'>3</td><td  align='left'>Yet another sample todo item</td><td  align='left'>0</td></tr>
</table>
<p class='vspace'>As the table shows, our todos only include a primary key (<code>id</code>), a title, and a status bit to indicate whether or not they are complete.
</p>
<div class='vspace'></div><h3>A REST API</h3>
<p>Our web application needs access to this database, so we&rsquo;ll provide a standard REST interface. The API follows Ruby conventions, but can be easily implemented by any server technology. In particular:
</p>
<div class='vspace'></div><ul><li><code>GET api/todos</code> returns a JSON-encoded array of all rows in the database.
</li><li><code>GET api/todos/NNN</code> returns the JSON representation of the todo with <code>id</code> equal to <code>NNN</code>.
</li><li><code>POST api/todos</code> adds a new todo to the database using the JSON-encoded information in the request.
</li><li><code>PUT api/todos/NNN</code> updates the todo with <code>id</code> equal to <code>NNN</code> using the JSON-encoded information in the request.
</li><li><code>DELETE api/todos/NNN</code> deletes the todo with <code>id</code> equal to <code>NNN</code> from the database.
</li></ul><p class='vspace'>If you&rsquo;re not particularly fond of Ruby, the source code includes a complete PHP implementation of this API.
</p>
<div class='vspace'></div><h3><span class='wikiword'>JavaScript</span> Libraries</h3>
<p>Our modest application is simple enough to implement in pure <span class='wikiword'>JavaScript</span> without any libraries, but we have far bigger plans. We may be starting small, but eventually the app will feature amazing functionality and a delightful user interface. In preparation for that day, we&rsquo;ll build on a framework that can support our ultimate killer app:
</p>
<div class='vspace'></div><ul><li><a class='external' href='http://jquery.com/' target='_blank'>jQuery</a> for DOM manipulation, event handling, and server communications.
</li><li><a class='external' href='http://underscorejs.org/' target='_blank'>Underscore.js</a> to enhance the core language with many indespensible utilities.
</li><li><a class='external' href='http://backbonejs.org/' target='_blank'>Backbone.js</a> to define the structure of the application in terms of models and views.
</li></ul><div class='vspace'></div><h3>An HTML Skeleton</h3>
<p>Now that we know the components that will comprise our application, we can define the HTML skeleton that will support it. There&rsquo;s nothing fancy about it (yet), just a minimal <span class='wikiword'>HTML5</span> document, some <span class='wikiword'>JavaScript</span> files, and a small bit of code to get things started.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock2'>
  <div class='sourceblocktext'><br /><strong>GeSHi Error:</strong> GeSHi could not find the language html (using path /srv/gandimouse2/home/home/tamara/Sites/tamwiki/cookbook/geshi/geshi/) (code 2)<br /></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=2' type='text/plain'>raw code</a></div>
</div>

<div class='vspace'></div><h2>Testing During Development</h2>
<p>Now that we&rsquo;ve selected our tools and specified the application, it&rsquo;s time to start development. Our first task is installing the tools.
</p>
<div class='vspace'></div><h3>Installing the Tools</h3>
<p>Even though we&rsquo;ll be developing in the browser, our test environment relies on node.js. The very first step, therefore, is installing node.js and the node package manager (npm). There are executable binaries for OS X, Windows, Linux, and <span class='wikiword'>SunOS</span> on the <a class='external' href='http://nodejs.org/download/' target='_blank'>node.js web site</a>, as well as a source code for other operating systems. After running the installer, you can verify both node.js and npm from the command line.
</p>
<div class='vspace'></div><pre>  bash-3.2$ node --version v0.8.18 bash-3.2$ npm --version 1.2.2 bash-3.2$
</pre><p class='vspace'>Everything else we need is conveniently available as a node package. The node package manager can handle their installation, as well as any dependencies.
</p>
<div class='vspace'></div><pre>  bash-3.2$ npm install jquery jsdom underscore backbone mocha chai sinon sinon-chai testem -g
</pre><div class='vspace'></div><h3>Creating the Project Structure</h3>
<p>The source code for this example includes a complete project structure with the following 15 files:
</p>
<div class='vspace'></div><pre> todos.html
 testem.json
 api/htaccess
 api/todos.php
 lib/backbone-min.js
 lib/chai.js
 lib/jquery-1.9.0.min.js
 lib/sinon-1.5.2.js
 lib/sinon-chai.js
 lib/underscore-min.js
 mysql/todos.sql
 php-lib/dbconfig.inc.php
 src/app-todos.js
 test/app-todos-test.js
 test/mocha.opts
</pre><p class='vspace'>Here is what each folder and file contains:
</p>
<div class='vspace'></div><ul><li><code>todos.html</code>: The skeleton HTML file for our application, shown in full above.
</li><li><code>testem.json</code>: The configuration file for Test&rsquo;Em; we&rsquo;ll look at this in detail shortly.
</li><li><code>api/</code>: A folder for our REST API implementation.
<ul><li><code>api/htaccess</code>: Sample configuration for the Apache web server that supports our REST API.
</li><li><code>api/todos.php</code>: PHP code to implement the REST API.
</li></ul></li><li><code>lib/</code>: A folder for <span class='wikiword'>JavaScript</span> libraries used by the app itself and the test framework.
<ul><li><code>lib/backbone-min.js</code>: Minified version of Backbone.js.
</li><li><code>lib/chai.js</code>: Chai Assertion Library.
</li><li><code>lib/jquery-1.9.0.min.js</code>: Minified version of jQuery.
</li><li><code>lib/sinon-1.5.2.js</code>: Sinon.JS library.
</li><li><code>lib/sinon-chai.js</code>: Sinon.JS Assertions for Chai.
</li><li><code>lib/underscore-min.js</code>: Minified version of Underscore.js.
</li></ul></li><li><code>mysql/</code>: A folder for <span class='wikiword'>MySQL</span> code for the application.
<ul><li><code>mysql/todos.sql</code>: <span class='wikiword'>MySQL</span> commands to create the application database.
</li></ul></li><li><code>php-lib/</code>: A folder for PHP libraries and configuration for the application&rsquo;s REST API.
<ul><li><code>php-lib/dbconfig.inc.php</code>: PHP database configuration for the REST API.
</li></ul></li><li><code>src/</code>: A folder for our client-side application code.
<ul><li><code>src/app-todos.js</code>: Our application.
</li></ul></li><li><code>test/</code>: A folder for test code.
<ul><li><code>test/app-todos-test.js</code>: Test code for our application.
</li><li><code>test/mocha.opts</code>: Configuration options for mocha; we&rsquo;ll look at this in the next section.
</li></ul></li></ul><p class='vspace'>During development, we&rsquo;re only interested in three of these files, <code>testem.json</code>, <code>src/app-todos.js</code>, and <code>test/app-todos-test.js</code>.
</p>
<div class='vspace'></div><h3>Configuring Test&rsquo;Em</h3>
<p>The last step before actual development is defining the Test&rsquo;Em configuration. That configuration resides in the JSON-formatted <code>testem.json</code>, and it&rsquo;s simple enough to create in any text editor. We simply specify that we&rsquo;re using Mocha (Test&rsquo;Em supports several frameworks), and we list the <span class='wikiword'>JavaScript</span> files our application and our test code requires.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock3'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1"><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="st0">&quot;framework&quot;</span><span class="sy0">:</span> <span class="st0">&quot;mocha&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="st0">&quot;src_files&quot;</span><span class="sy0">:</span> <span class="br0">&#91;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;lib/jquery-1.9.0.min.js&quot;</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;lib/underscore-min.js&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;lib/backbone-min.js&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;src/*.js&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;lib/chai.js&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;lib/sinon-chai.js&quot;</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;lib/sinon-1.5.2.js&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;test/*.js&quot;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#93;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=3' type='text/plain'>raw code</a></div>
</div>

<div class='vspace'></div><h3>Start Developing</h3>
<p>Finally, we&rsquo;re ready to code. In a command shell, navigate to the root folder of our project and execute the command <code>testem</code>. The Test&rsquo;Em scripts will run, clearing the terminal window and giving us a URL in the upper right. Copy and paste that URL into our browser of choice and we&rsquo;re off.
</p>
<div class='vspace'></div><div><img src='http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2013/02/02-jstest-testem.png' alt='' title='' /></div>
<p class='vspace'>As soon as we launch the web browser, it will automatically execute any tests that we&rsquo;ve defined. Since we&rsquo;re just beginning development, we won&rsquo;t have any code, nor any test cases. The browser will kindly point that out to us.
</p>
<div class='vspace'></div><div><img src='http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2013/02/03-jstest-browser-none.png' alt='' title='' /></div>
<p class='vspace'>The terminal window from which we launched Test&rsquo;Em will also give us the status.
</p>
<div class='vspace'></div><div><img src='http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2013/02/04-jstest-console-none.png' alt='' title='' /></div>
<div class='vspace'></div><h3>A First Test Case</h3>
<p>In the spirit of true Test-Driven Development, we&rsquo;ll begin by writing our first test case in the <code>test/app-todos-test.js</code> file. Like any good web app, we want to minimize global name space pollution. To do that, we&rsquo;ll rely on a single global variable, <code>todoApp</code>, to contain all of our code. Our first test case will make sure that the global name space variable exists.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock4'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1"><span class="kw1">var</span> should <span class="sy0">=</span> chai.<span class="me1">should</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;</div></li>
<li class="li1"><div class="de1">&nbsp;describe<span class="br0">&#40;</span><span class="st0">&quot;Application&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;creates a global variable for the name space&quot;</span><span class="sy0">,</span> <span class="kw1">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;should.<span class="me1">exist</span><span class="br0">&#40;</span>todoApp<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=4' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>As you can see, we need one preliminary statement to tell Mocha that we&rsquo;re using Chai assertions. Then we can begin writing tests. By convention <span class='wikiword'>JavaScript</span> tests are organized into blocks (which can be nested into sub-blocks, and so on). Each block begins with a <code>describe()</code> function call to identify what part of the code we&rsquo;re testing. In this case we&rsquo;re testing the overall application, so that&rsquo;s the first parameter to <code>describe()</code>.
</p>
<p class='vspace'>Within a test block, we document each test case by what it tests. That&rsquo;s the purpose of the <code>it()</code> function. The way to read any test case is to combine the <code>describe()</code> and <code>it()</code> strings into a single statement. Our first test case, therefore, is
</p>
<div class='vspace'></div><div class='indent'>Application creates a global variable for the name space
</div><p class='vspace'>The test code itself is inside the <code>it()</code> block. Our test case is
</p>
<div class='vspace'></div><pre> should.exist(todoApp);
</pre><p class='vspace'>Now we have a complete test case. As soon as we save the file, Test`Em automatically takes over. It notices that one of our files has changed, so it immediately reruns the tests. Not surprisingly (since we haven&rsquo;t written any code for the application yet), our first test fails.
</p>
<div class='vspace'></div><div><img src='http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2013/02/05-jstest-browser-fail.png' alt='' title='' /></div>
<p class='vspace'>The terminal window updates automatically as well.
</p>
<div class='vspace'></div><div><img src='http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2013/02/06-jstest-console-fail.png' alt='' title='' /></div>
<p class='vspace'>To make the test pass, we must create the global name space variable. We shift to the <code>srcapp-todos.js</code> file and add the necessary code.
</p>
<div class='vspace'></div><pre> if (typeof todoApp === "undefined") todoApp = {};
</pre><p class='vspace'>As soon as we save the file, Test`Em once again springs into action. We immediately get updated results for our test cases.
</p>
<div class='vspace'></div><div><img src='http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2013/02/07-jstest-browser-pass.png' alt='' title='' /></div>
<p class='vspace'>Step back for a moment and consider what&rsquo;s happening! Every time we make a change, either to the test code or to our application, Test`Em immediately re-runs our entire test suite. All we have to do is keep Test&rsquo;Em&rsquo;s browser or terminal window visible in a corner of our screen, and we can see the health of our code in real time, <em>as we&rsquo;re developing</em>. We&rsquo;ll know as soon as we introduce a bug, even if the bug manifests itself in a part of the code different from where we&rsquo;re working. No more digging back through hours, days, or weeks of new code to figure out when we introduced a bug.
</p>
<div class='vspace'></div><h3>Testing the Model</h3>
<p>With our development environment now fully established, we can begin developing the application. Since our app shows a list of todos, it might be good to create a model for those todos. The model will need to keep track of both the title of the todo and it&rsquo;s status. Let&rsquo;s add a unit test that verifies we can create an todo with reasonable defaults.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock5'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">describe<span class="br0">&#40;</span><span class="st0">&quot;Todo Model&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;describe<span class="br0">&#40;</span><span class="st0">&quot;Initialization&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;beforeEach<span class="br0">&#40;</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">Todo</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should default the status to 'pending'&quot;</span><span class="sy0">,</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span>.<span class="kw1">get</span><span class="br0">&#40;</span><span class="st0">'complete'</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">be</span>.<span class="kw2">false</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should default the title to an empty string&quot;</span><span class="sy0">,</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span>.<span class="kw1">get</span><span class="br0">&#40;</span><span class="st0">'title'</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">equal</span><span class="br0">&#40;</span><span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=5' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>There are several aspects of these tests worth noting.
</p>
<div class='vspace'></div><ul><li>We can nest test blocks within each other. One test block will contain all the unit tests for the todo model, and a sub-block of those tests focuses on initialization.
</li><li>Within a test block, we can define functionality to execute before every test. That&rsquo;s the purpose of the <code>beforeEach()</code> block. In the example above, we&rsquo;re creating a new instance of a Todo before every test.
</li><li>The Mocha framework automatically makes sure that the <span class='wikiword'>JavaScript</span> context (i.e. the value of <code>this</code>) is consistent for all our test cases. That&rsquo;s why we can define <code>this.todo</code> in one function (the <code>beforeEach()</code> parameter) and safely reference it in other functions (such as the <code>it()</code> parameters). Without Mocha working behind the scenes to provide this consistency, <span class='wikiword'>JavaScript</span> would define different contexts for each function.
</li></ul><p class='vspace'>Of course, since we haven&rsquo;t written the model code yet, all our tests will fail. (And we&rsquo;ll know that immediately.) But once we&rsquo;ve added the code for our model, the tests pass and we&rsquo;re on our way.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock6'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">todoApp.<span class="me1">Todo</span> <span class="sy0">=</span> Backbone.<span class="me1">Model</span>.<span class="me1">extend</span><span class="br0">&#40;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;defaults<span class="sy0">:</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;title<span class="sy0">:</span> <span class="st0">&quot;&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;complete<span class="sy0">:</span> &nbsp;<span class="kw2">false</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=6' type='text/plain'>raw code</a></div>
</div>

<div class='vspace'></div><h3>Using Stubs for Third Party Functionality</h3>
<p>Now that we have a simple model for todos, we can start to define its behavior. One thing our model should do is update the database whenever any of its properties change. In a unit test environment, however, we won&rsquo;t have an actual database to check. On the other hand, we&rsquo;re not actually writing any code to do the database update. Rather, we&rsquo;re relying on Backbone to handle that interaction. That suggests a unit test strategy for this test case. All we need to know is that Backbone models use the <code>save()</code> method to update whatever backing store is persisting the model. In our case that backing store is the database. Here is the unit test code we can use:
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock7'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">describe<span class="br0">&#40;</span><span class="st0">&quot;Persistence&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;beforeEach<span class="br0">&#40;</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">Todo</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">save_stub</span> <span class="sy0">=</span> sinon.<span class="me1">stub</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">todo</span><span class="sy0">,</span> <span class="st0">&quot;save&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;afterEach<span class="br0">&#40;</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">save_stub</span>.<span class="me1">restore</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should update server when title is changed&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span>.<span class="kw1">set</span><span class="br0">&#40;</span><span class="st0">&quot;title&quot;</span><span class="sy0">,</span> <span class="st0">&quot;New Summary&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">save_stub</span>.<span class="me1">should</span>.<span class="me1">have</span>.<span class="me1">been</span>.<span class="me1">calledOnce</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should update server when status is changed&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span>.<span class="kw1">set</span><span class="br0">&#40;</span><span class="st0">'complete'</span><span class="sy0">,</span><span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">save_stub</span>.<span class="me1">should</span>.<span class="me1">have</span>.<span class="me1">been</span>.<span class="me1">calledOnce</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=7' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>We&rsquo;ve included some additional code before each test, and we&rsquo;ve added a section of code to execute after each test. That extra code manages a sinon <code>stub</code>, a function that effectively nullifies another function in the code. In our case the stub nullifies the <code>save()</code> method of <code>this.todo</code>. With the stub in place, calls to the method won&rsquo;t actually go to the Backnone library. Instead, sinon intercepts those calls and simply returns immediately. This behavior is important. If we tried to execute the actual Backbone <code>save()</code> method in a unit test environment, the call would fail because there would not be a database or server API available.
</p>
<p class='vspace'>With the stub in place, our test cases can use it to verify the model&rsquo;s behavior. In the first test case, we immediately set the todo&rsquo;s <code>title</code> to a new value. Since that changes the <code>title</code> property, we want our model to update its backing store. To check that we simply verify that the stub was called. To get our model to pass these tests, we can look for change events and respond appropriately.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock8'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">todoApp.<span class="me1">Todo</span> <span class="sy0">=</span> Backbone.<span class="me1">Model</span>.<span class="me1">extend</span><span class="br0">&#40;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;defaults<span class="sy0">:</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;title<span class="sy0">:</span> <span class="st0">&quot;&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;complete<span class="sy0">:</span> &nbsp;<span class="kw2">false</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;initialize<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">on</span><span class="br0">&#40;</span><span class="st0">&quot;change&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="kw1">this</span>.<span class="me1">save</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=8' type='text/plain'>raw code</a></div>
</div>

<div class='vspace'></div><h3>Testing the View</h3>
<p>Of course, our app won&rsquo;t do anyone any good if it doesn&rsquo;t actually display the todos to users, and that requires creating some HTML. We&rsquo;ll use Backbone views for that functionality. In our trivial app, we simply wish to render each todo as a list item. Here are the test cases that will get us started.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock9'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">describe<span class="br0">&#40;</span><span class="st0">&quot;Todo List Item View&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;beforeEach<span class="br0">&#40;</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">Todo</span><span class="br0">&#40;</span><span class="br0">&#123;</span>title<span class="sy0">:</span> <span class="st0">&quot;Summary&quot;</span><span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">TodoListItem</span><span class="br0">&#40;</span><span class="br0">&#123;</span>model<span class="sy0">:</span> <span class="kw1">this</span>.<span class="me1">todo</span><span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;render() should return the view object&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.<span class="me1">render</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">equal</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">item</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should render as a list item&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.<span class="me1">render</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">el</span>.<span class="me1">nodeName</span>.<span class="me1">should</span>.<span class="me1">equal</span><span class="br0">&#40;</span><span class="st0">&quot;LI&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=9' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>We begin our tests of the view with two test cases. First we ensure that the view&rsquo;s <code>render()</code> method returns the view itself. That&rsquo;s a common and very convenient convention in Backbone because it allows method chaining. Our second test case verifies that the HTML element the render creates is a list item (<code>&lt;li&gt;</code>). The code necessary to pass these tests is a straightforward Backbone view.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock10'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">todoApp.<span class="me1">TodoListItem</span> <span class="sy0">=</span> Backbone.<span class="me1">View</span>.<span class="me1">extend</span><span class="br0">&#40;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;tagName<span class="sy0">:</span> <span class="st0">&quot;li&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;render<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw1">this</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=10' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>Next, we can develop the detailed content of that list item view. As an example, we want the full list item to look something like the following.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock11'>
  <div class='sourceblocktext'><br /><strong>GeSHi Error:</strong> GeSHi could not find the language html (using path /srv/gandimouse2/home/home/tamara/Sites/tamwiki/cookbook/geshi/geshi/) (code 2)<br /></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=11' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>For our test cases, we can take advantage of jQuery to extract individual elements from the view&rsquo;s main element.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock12'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">describe<span class="br0">&#40;</span><span class="st0">&quot;Todo List Item View&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;beforeEach<span class="br0">&#40;</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">Todo</span><span class="br0">&#40;</span><span class="br0">&#123;</span>title<span class="sy0">:</span> <span class="st0">&quot;Summary&quot;</span><span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">TodoListItem</span><span class="br0">&#40;</span><span class="br0">&#123;</span>model<span class="sy0">:</span> <span class="kw1">this</span>.<span class="me1">todo</span><span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;describe<span class="br0">&#40;</span><span class="st0">&quot;Template&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;beforeEach<span class="br0">&#40;</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.<span class="me1">render</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span> &nbsp;</div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should contain the todo title as text&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.$el.<span class="me1">text</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">have</span>.<span class="me1">string</span><span class="br0">&#40;</span><span class="st0">&quot;Summary&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should include a label for the status&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.$el.<span class="me1">find</span><span class="br0">&#40;</span><span class="st0">&quot;label&quot;</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">have</span>.<span class="me1">length</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should include an &amp;lt;input&amp;gt; checkbox&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.$el.<span class="me1">find</span><span class="br0">&#40;</span><span class="st0">&quot;label&amp;gt;input[type='checkbox']&quot;</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">have</span>.<span class="me1">length</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should be clear by default (for 'pending' todos)&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.$el.<span class="me1">find</span><span class="br0">&#40;</span><span class="st0">&quot;label&amp;gt;input[type='checkbox']&quot;</span><span class="br0">&#41;</span>.<span class="me1">is</span><span class="br0">&#40;</span><span class="st0">&quot;:checked&quot;</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">be</span>.<span class="kw2">false</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should be set for 'complete' todos&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">save_stub</span> <span class="sy0">=</span> sinon.<span class="me1">stub</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">todo</span><span class="sy0">,</span> <span class="st0">&quot;save&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span>.<span class="kw1">set</span><span class="br0">&#40;</span><span class="st0">&quot;complete&quot;</span><span class="sy0">,</span> <span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.<span class="me1">render</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.$el.<span class="me1">find</span><span class="br0">&#40;</span><span class="st0">&quot;label&amp;gt;input[type='checkbox']&quot;</span><span class="br0">&#41;</span>.<span class="me1">is</span><span class="br0">&#40;</span><span class="st0">&quot;:checked&quot;</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">be</span>.<span class="kw2">true</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">save_stub</span>.<span class="me1">restore</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=12' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>Notice that in the last test case we&rsquo;ve stubbed the model&rsquo;s <code>save()</code> method. Since we&rsquo;re changing a property from its default value, our model will dutifully try to persist that change to its backing store. In a unit test environment, however, we won&rsquo;t have a database or a server API. The stub takes the place of the missing components and allows the tests to proceed without error. To get these tests to pass, we&rsquo;ll have to add some additional code to our view.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock13'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">todoApp.<span class="me1">TodoListItem</span> <span class="sy0">=</span> Backbone.<span class="me1">View</span>.<span class="me1">extend</span><span class="br0">&#40;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;tagName<span class="sy0">:</span> <span class="st0">&quot;li&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;template<span class="sy0">:</span> _.<span class="me1">template</span><span class="br0">&#40;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;&amp;lt;label&amp;gt;&quot;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="sy0">+</span> &nbsp; <span class="st0">&quot;&amp;lt;input type='checkbox' &amp;lt;% if(complete) print('checked') %&amp;gt;/&amp;gt;&quot;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="sy0">+</span> &nbsp; <span class="st0">&quot; &amp;lt;%= title %&amp;gt; &quot;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="sy0">+</span> <span class="st0">&quot;&amp;lt;/label&amp;gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;render<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.$el.<span class="me1">html</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">template</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">model</span>.<span class="me1">attributes</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw1">this</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=13' type='text/plain'>raw code</a></div>
</div>

<div class='vspace'></div><h3>Testing Model/View Interactions</h3>
<p>Now that we&rsquo;ve verified that our view implementation creates the right HTML markup, we can test its interaction with our model. In particular, we want to make sure that users can toggle a todo&rsquo;s status by clicking on the checkbox. Our test environment doesn&rsquo;t require an actual human user, so we&rsquo;ll use jQuery to generate the click event. To do that, however, we&rsquo;ll have to add content to a real live DOM. That content is known as a test <em>fixture</em>. Here is the unit test code.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock14'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">describe<span class="br0">&#40;</span><span class="st0">&quot;Todo List Item View&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;beforeEach<span class="br0">&#40;</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">Todo</span><span class="br0">&#40;</span><span class="br0">&#123;</span>title<span class="sy0">:</span> <span class="st0">&quot;Summary&quot;</span><span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">TodoListItem</span><span class="br0">&#40;</span><span class="br0">&#123;</span>model<span class="sy0">:</span> <span class="kw1">this</span>.<span class="me1">todo</span><span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">save_stub</span> <span class="sy0">=</span> sinon.<span class="me1">stub</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">todo</span><span class="sy0">,</span> <span class="st0">&quot;save&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;afterEach<span class="br0">&#40;</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">save_stub</span>.<span class="me1">restore</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;describe<span class="br0">&#40;</span><span class="st0">&quot;Model Interaction&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should update model when checkbox clicked&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;$<span class="br0">&#40;</span><span class="st0">&quot;&amp;lt;div&amp;gt;&quot;</span><span class="br0">&#41;</span>.<span class="me1">attr</span><span class="br0">&#40;</span><span class="st0">&quot;id&quot;</span><span class="sy0">,</span><span class="st0">&quot;fixture&quot;</span><span class="br0">&#41;</span>.<span class="me1">css</span><span class="br0">&#40;</span><span class="st0">&quot;display&quot;</span><span class="sy0">,</span><span class="st0">&quot;none&quot;</span><span class="br0">&#41;</span>.<span class="me1">appendTo</span><span class="br0">&#40;</span><span class="st0">&quot;body&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.<span class="me1">render</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;$<span class="br0">&#40;</span><span class="st0">&quot;#fixture&quot;</span><span class="br0">&#41;</span>.<span class="me1">append</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">item</span>.$el<span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">item</span>.$el.<span class="me1">find</span><span class="br0">&#40;</span><span class="st0">&quot;input&quot;</span><span class="br0">&#41;</span>.<span class="me1">click</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todo</span>.<span class="kw1">get</span><span class="br0">&#40;</span><span class="st0">'complete'</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">be</span>.<span class="kw2">true</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;$<span class="br0">&#40;</span><span class="st0">&quot;#fixture&quot;</span><span class="br0">&#41;</span>.<span class="me1">remove</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=14' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>Notice that we&rsquo;re once again stubbing the todo&rsquo;s <code>save()</code> method. Otherwise, Backbone will try to update a non-existent backing store when we change the todo status with our simulated click.
</p>
<p class='vspace'>For the test case itself, we begin by creating a <code>&lt;div&gt;</code> element with an <code>id</code> of <code>fixture</code> and we add that element to our live document. The live document, in this case, is the web page displaying the results of our tests. Although we remove the element immediately after verifying the test case, we also set its <code>display</code> property to <code>none</code> so it won&rsquo;t interfere with Mocha&rsquo;s display of the test results. The code that implements this functionality includes a small addition to the todo model. The addition is a new <code>toggleStatus()</code> method.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock15'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">todoApp.<span class="me1">Todo</span> <span class="sy0">=</span> Backbone.<span class="me1">Model</span>.<span class="me1">extend</span><span class="br0">&#40;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;defaults<span class="sy0">:</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;title<span class="sy0">:</span> <span class="st0">&quot;&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;complete<span class="sy0">:</span> &nbsp;<span class="kw2">false</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;initialize<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">on</span><span class="br0">&#40;</span><span class="st0">&quot;change&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="kw1">this</span>.<span class="me1">save</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;toggleStatus<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="kw1">set</span><span class="br0">&#40;</span><span class="st0">&quot;complete&quot;</span><span class="sy0">,!</span><span class="kw1">this</span>.<span class="kw1">get</span><span class="br0">&#40;</span><span class="st0">&quot;complete&quot;</span><span class="st0">&quot;));</span></div></li>
<li class="li1"><div class="de1"><span class="st0"> &nbsp; }</span></div></li>
<li class="li1"><div class="de1"><span class="st0"> })</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=15' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>In the view, we want to catch click events on the <code>&lt;input&gt;</code> element and call this method for the model.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock16'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">todoApp.<span class="me1">TodoListItem</span> <span class="sy0">=</span> Backbone.<span class="me1">View</span>.<span class="me1">extend</span><span class="br0">&#40;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;tagName<span class="sy0">:</span> <span class="st0">&quot;li&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;template<span class="sy0">:</span> _.<span class="me1">template</span><span class="br0">&#40;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;&amp;lt;label&amp;gt;&quot;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="sy0">+</span> &nbsp; <span class="st0">&quot;&amp;lt;input type='checkbox' &amp;lt;% if(complete) print('checked') %&amp;gt;/&amp;gt;&quot;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="sy0">+</span> &nbsp; <span class="st0">&quot; &amp;lt;%= title %&amp;gt; &quot;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="sy0">+</span> <span class="st0">&quot;&amp;lt;/label&amp;gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;events<span class="sy0">:</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="st0">&quot;click input&quot;</span><span class="sy0">:</span> <span class="st0">&quot;statusChanged&quot;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;render<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.$el.<span class="me1">html</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">template</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">model</span>.<span class="me1">attributes</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw1">this</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;statusChanged<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">model</span>.<span class="me1">toggleStatus</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=16' type='text/plain'>raw code</a></div>
</div>

<div class='vspace'></div><h3>Testing the Collection</h3>
<p>At this point our application is nearly complete. The only remaining functionality is collecting all the todos together. Naturally, we&rsquo;ll use a Backbone collection. We&rsquo;re actually not going to do anything special with our collection, so we don&rsquo;t really need any unit tests.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock17'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">todoApp.<span class="me1">Todos</span> <span class="sy0">=</span> Backbone.<span class="me1">Collection</span>.<span class="me1">extend</span><span class="br0">&#40;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;model<span class="sy0">:</span> todoApp.<span class="me1">Todo</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;url<span class="sy0">:</span> &nbsp; <span class="st0">&quot;api/todos&quot;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=17' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>We can, however, verify that our implementation of the collection&rsquo;s view is appropriate. We want that view rendered as an unordered list (<code>&lt;ul&gt;</code>). The test cases don&rsquo;t require any functionality that we haven&rsquo;t seen before.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock18'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">describe<span class="br0">&#40;</span><span class="st0">&quot;Todos List View&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;beforeEach<span class="br0">&#40;</span><span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todos</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">Todos</span><span class="br0">&#40;</span><span class="br0">&#91;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#123;</span>title<span class="sy0">:</span> <span class="st0">&quot;Todo 1&quot;</span><span class="br0">&#125;</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#123;</span>title<span class="sy0">:</span> <span class="st0">&quot;Todo 2&quot;</span><span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">list</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">TodosList</span><span class="br0">&#40;</span><span class="br0">&#123;</span>collection<span class="sy0">:</span> <span class="kw1">this</span>.<span class="me1">todos</span><span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;render() should return the view object&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">list</span>.<span class="me1">render</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">equal</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">list</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should render as an unordered list&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">list</span>.<span class="me1">render</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">el</span>.<span class="me1">nodeName</span>.<span class="me1">should</span>.<span class="me1">equal</span><span class="br0">&#40;</span><span class="st0">&quot;UL&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should include list items for all models in collection&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">list</span>.<span class="me1">render</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">list</span>.$el.<span class="me1">find</span><span class="br0">&#40;</span><span class="st0">&quot;li&quot;</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">have</span>.<span class="me1">length</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=18' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>The view implementation is also straightforward. It tracks any additions to the collection and updates the view. For the initial <code>render()</code> it simply adds all the models in the collection one at a time.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock19'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">todoApp.<span class="me1">TodosList</span> <span class="sy0">=</span> Backbone.<span class="me1">View</span>.<span class="me1">extend</span><span class="br0">&#40;</span><span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;tagName<span class="sy0">:</span> <span class="st0">&quot;ul&quot;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;initialize<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">collection</span>.<span class="me1">on</span><span class="br0">&#40;</span><span class="st0">&quot;add&quot;</span><span class="sy0">,</span> <span class="kw1">this</span>.<span class="me1">addOne</span><span class="sy0">,</span> <span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;render<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">addAll</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">return</span> <span class="kw1">this</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;addAll<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">collection</span>.<span class="me1">each</span><span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">addOne</span><span class="sy0">,</span> <span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="sy0">,</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;addOne<span class="sy0">:</span> <span class="kw1">function</span><span class="br0">&#40;</span>todo<span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">var</span> item <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">TodoListItem</span><span class="br0">&#40;</span><span class="br0">&#123;</span>model<span class="sy0">:</span> todo<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.$el.<span class="me1">append</span><span class="br0">&#40;</span>item.<span class="me1">render</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">el</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=19' type='text/plain'>raw code</a></div>
</div>

<div class='vspace'></div><h3>Bonus Tests: Verifying the API</h3>
<p>Because our REST API perfectly matches the API that Backbone expects, we didn&rsquo;t need any custom code to manage the API interaction. As a result, we don&rsquo;t need any unit test cases. In the real world, you might not be quite as lucky. If your API doesn&rsquo;t conform to Backbone conventions, you may need to override or extend some of the Backbone code to deal with the non-standard API. That extra code will need unit tests as well. Fortunately, it&rsquo;s relatively easy to test API interactions, even in a unit test environment.
</p>
<p class='vspace'>The easiest way to test API interactions relies on the fake server functionality of Sinon.JS. Unfortunately, that functionality is only available (currently) in Sinon&rsquo;s browser implementation. It is explicitly excluded from the node.js implementation. There are some hacks to get it running in node.js, but those hacks are quite brittle and rely on internal implementation details. It would be best to avoid them if possible. Fortunately, we can get by without Sinon&rsquo;s fake server.
</p>
<p class='vspace'>The secret is knowing that Backbone relies on jQuery&rsquo;s <code>$.ajax()</code> function to implement REST <span class='wikiword'>APIs</span>. We can intercept the API interactions by stubbing that function. When we stub the function, we&rsquo;ll want to substitute our own response. The <code>yieldsTo()</code> method of the stub gives us exactly that opportunity. It tells sinon what additional action it should take when the stub is called. Here&rsquo;s a complete test case to verify that our collection correctly initializes itself using the REST API.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock20'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1">describe<span class="br0">&#40;</span><span class="st0">&quot;Collection's Interaction with REST API&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;it<span class="br0">&#40;</span><span class="st0">&quot;should load using the API&quot;</span><span class="sy0">,</span> <span class="kw1">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">ajax_stub</span> <span class="sy0">=</span> sinon.<span class="me1">stub</span><span class="br0">&#40;</span>$<span class="sy0">,</span> <span class="st0">&quot;ajax&quot;</span><span class="br0">&#41;</span>.<span class="me1">yieldsTo</span><span class="br0">&#40;</span><span class="st0">&quot;success&quot;</span><span class="sy0">,</span> <span class="br0">&#91;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#123;</span> id<span class="sy0">:</span> <span class="nu0">1</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">&quot;Mock Summary 1&quot;</span><span class="sy0">,</span> complete<span class="sy0">:</span> <span class="kw2">false</span> <span class="br0">&#125;</span><span class="sy0">,</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#123;</span> id<span class="sy0">:</span> <span class="nu0">2</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">&quot;Mock Summary 2&quot;</span><span class="sy0">,</span> complete<span class="sy0">:</span> <span class="kw2">true</span> &nbsp;<span class="br0">&#125;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todos</span> <span class="sy0">=</span> <span class="kw1">new</span> todoApp.<span class="me1">Todos</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todos</span>.<span class="me1">fetch</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todos</span>.<span class="me1">should</span>.<span class="me1">have</span>.<span class="me1">length</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todos</span>.<span class="me1">at</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span>.<span class="kw1">get</span><span class="br0">&#40;</span><span class="st0">'title'</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">equal</span><span class="br0">&#40;</span><span class="st0">&quot;Mock Summary 1&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">todos</span>.<span class="me1">at</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>.<span class="kw1">get</span><span class="br0">&#40;</span><span class="st0">'title'</span><span class="br0">&#41;</span>.<span class="me1">should</span>.<span class="me1">equal</span><span class="br0">&#40;</span><span class="st0">&quot;Mock Summary 2&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp; &nbsp;<span class="kw1">this</span>.<span class="me1">ajax_stub</span>.<span class="me1">restore</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="br0">&#125;</span><span class="br0">&#41;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=20' type='text/plain'>raw code</a></div>
</div>

<div class='vspace'></div><h3>Finished!</h3>
<p>As you can see from the screen shot that follows, we&rsquo;ve now written code that passes all the unit test cases. For the time being at least, development is complete.
</p>
<div class='vspace'></div><div><img src='http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2013/02/08-jstest-browser-all.png' alt='' title='' /></div>
<div class='vspace'></div><h2>Testing During Integration</h2>
<p>Now that client-side development of our app is complete (and we have the tests to prove it), we can safely tuck our <span class='wikiword'>JavaScript</span> into a source code management system. It can then be integrated into the build process for the entire application. As part of that process, we want to execute all the test cases we&rsquo;ve developed. That will ensure that the code that makes up the final deployment passes all the tests that we&rsquo;ve defined. It will also protect against "minor tweaks" to the code that inadvertently introduce new bugs.
</p>
<p class='vspace'>During the build process, we&rsquo;ll likely want to execute our tests from the command line rather than in a web browser. We don&rsquo;t need the details of individual test cases, just an assurance that they all pass. Node.js makes it easy enough to accommodate this requirement. We only need to make a few small additions to our source code and unit test code files.
</p>
<p class='vspace'>Our code needs these modifications because node.js handles global variables differently than web browsers. In a web browser, <span class='wikiword'>JavaScript</span> variables are, by default, global in scope. Node.js, on the other hand, confines variables to their local module by default. In that environment, our code won&rsquo;t be able to find the third-party libraries it needs (jQuery, Underscore, and Backbone. If we add the following statements at the beginning, though, node.js will resolve references to these libraries appropriately. We&rsquo;ve constructed these statements so that they do no harm in the web browser, so we can leave them in the code permanently.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock21'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1"><span class="kw1">var</span> jQuery &nbsp; <span class="sy0">=</span> jQuery &nbsp; <span class="sy0">||</span> require<span class="br0">&#40;</span><span class="st0">&quot;jquery&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="kw1">var</span> _ &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">=</span> _ &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">||</span> require<span class="br0">&#40;</span><span class="st0">&quot;underscore&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;<span class="kw1">var</span> Backbone <span class="sy0">=</span> Backbone <span class="sy0">||</span> require<span class="br0">&#40;</span><span class="st0">&quot;backbone&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp;Backbone.$ &nbsp; <span class="sy0">=</span> jQuery<span class="sy0">;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=21' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>We also need to adjust our test code. The test scripts need access to their own libraries (jQuery, Chai, Sinon.JS, and sinon-chai). In addition, we need to add a little extra to simulate a web browser&rsquo;s Document Object Model (DOM). Recall that our tests for click handling required us to temporarily add a "fixture" <code>&lt;div&gt;</code> to the web page. Node.js, of course, doesn&rsquo;t normally have a web page. The jsdom node package, however, lets us emulate one. The code below creates a minimal, simulated web page for our tests.
</p>
<div class='vspace'></div>
<div class='sourceblock ' id='sourceblock22'>
  <div class='sourceblocktext'><div class="javascript"><ol><li class="li1"><div class="de1"><span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw1">typeof</span> exports <span class="sy0">!==</span> <span class="st0">'undefined'</span> <span class="sy0">&amp;</span>amp<span class="sy0">;&amp;</span>amp<span class="sy0">;</span> <span class="kw1">this</span>.<span class="me1">exports</span> <span class="sy0">!==</span> exports<span class="br0">&#41;</span> <span class="br0">&#123;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;global.<span class="me1">jQuery</span> <span class="sy0">=</span> require<span class="br0">&#40;</span><span class="st0">&quot;jquery&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;global.$ <span class="sy0">=</span> jQuery<span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;global.<span class="me1">chai</span> <span class="sy0">=</span> require<span class="br0">&#40;</span><span class="st0">&quot;chai&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp; &nbsp;global.<span class="me1">sinon</span> <span class="sy0">=</span> require<span class="br0">&#40;</span><span class="st0">&quot;sinon&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;chai.<span class="me1">use</span><span class="br0">&#40;</span>require<span class="br0">&#40;</span><span class="st0">&quot;sinon-chai&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;global.<span class="me1">jsdom</span> <span class="sy0">=</span> require<span class="br0">&#40;</span><span class="st0">&quot;jsdom&quot;</span><span class="br0">&#41;</span>.<span class="me1">jsdom</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;<span class="kw1">var</span> doc <span class="sy0">=</span> jsdom<span class="br0">&#40;</span><span class="st0">&quot;&amp;lt;html&amp;gt;&amp;lt;body&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li1"><div class="de1">&nbsp; &nbsp;global.<span class="me1">window</span> <span class="sy0">=</span> doc.<span class="me1">createWindow</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></div></li>
<li class="li2"><div class="de2">&nbsp;<span class="br0">&#125;</span></div></li>
</ol></div></div>
  <div class='sourceblocklink'><a href='http://wiki.tamouse.org?n=Technology.UnitTestingBackbonejsApplications20130826085139?action=sourceblock&amp;num=22' type='text/plain'>raw code</a></div>
</div>

<p class='vspace'>The conditional that wraps these statements tests to see if we&rsquo;re running in the node.js environment instead of a web browser. In a browser, the extra statements aren&rsquo;t necessary, so we can safely skip them.
</p>
<p class='vspace'>With those changes, we can execute the full test suite from the command line. Simply navigate to the project&rsquo;s root folder and execute the command <code>mocha</code>. The result looks quite familiar.
</p>
<div class='vspace'></div><div><img src='http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2013/02/09-jstest-node.png' alt='' title='' /></div>
<p class='vspace'>Of course, <code>mocha</code> returns an exit level to indicate whether or not all of the tests passed. That lets us automate the tests as part of a continuous integration process, or simply as a local pre-commit script to preserve our own sanity.
</p>
<div class='vspace'></div><h2>Conclusion</h2>
<p>At this point we have accomplished our goals. We have a unit test environment that runs in the background during development and immediately notifies us when any test fails. The tests execute in a web browser, giving us full access to the browser&rsquo;s development tools while we&rsquo;re coding. The same tests also run equally well from a command line script, so we can automate their execution during the build or integration process.
</p>
<div class='vspace'></div><h2>Resources</h2>
<p>Here are the main unit test resources used in the article.
</p>
<div class='vspace'></div><ul><li>Command line <span class='wikiword'>JavaScript</span> execution environment: <a class='external' href='http://nodejs.org/' target='_blank'>node.js</a>
</li><li><span class='wikiword'>JavaScript</span> unit testing framework: <a class='external' href='http://visionmedia.github.com/mocha/' target='_blank'>Mocha</a>
</li><li>Test Development Environment: <a class='external' href='https://github.com/airportyh/testem' target='_blank'>Test&rsquo;em</a>
</li><li><span class='wikiword'>JavaScript</span> assertion library: <a class='external' href='http://chaijs.com/' target='_blank'>Chai Assertion Library</a>
</li><li>Spies, stubs, and mocks: <a class='external' href='http://sinonjs.org/' target='_blank'>Sinon.JS</a>
</li><li>Additional assertions: <a class='external' href='https://github.com/domenic/sinon-chai' target='_blank'>Sinon.JS Assertions for Chai</a>
</li></ul><p class='vspace'>&copy; 2000 &ndash; 2013 <span class='wikiword'>SitePoint</span> Pty. Ltd.
</p>
<div class='vspace'></div><div  style='display: none;' > 
<p>Summary: This article provides a thorough examination of unit testing with Backbone.js.
Tags: saved page
Source: <a class='external' href='http://www.sitepoint.com/unit-testing-backbone-js-applications/' target='_blank'>http://www.sitepoint.com/unit-testing-backbone-js-applications/</a>
Parent: (Technology.)<span class='wikiword'><a class='wikilink' href='http://wiki.tamouse.org?n=Technology.BackboneJS?action=print'>BackboneJS</a></span>
includeme: [[<span class='wikiword'><a class='wikilink' href='http://wiki.tamouse.org?n=Technology.BackboneJS?action=print'>Technology.BackboneJS</a></span>]
Categories:<a class='categorylink' href='http://wiki.tamouse.org?n=Category.Articles'>Articles</a>, <a class='categorylink' href='http://wiki.tamouse.org?n=Category.HowTos'>HowTos</a>
Posted: Mon, 26 Aug 2013 08:51:39 -0500
</p></div>
<div class='vspace'></div>
</div>

</body>
</html>
