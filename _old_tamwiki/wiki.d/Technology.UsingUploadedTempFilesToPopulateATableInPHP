version=pmwiki-2.2.38 ordered=1 urlencoded=1
agent=Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:14.0) Gecko/20100101 Firefox/14.0.1
author=tamara
charset=ISO-8859-1
csum=add references
ctime=1343365348
host=71.63.211.0
name=Technology.UsingUploadedTempFilesToPopulateATableInPHP
rev=3
targets=Technology.UsingUploadedTempFilesToPopulateATableInPHP,Technology.PHP,Technology.IncludeMe,Category.Articles,Technology.MySQL
text=>>comment%3c%3c%0aSummary:A solution to a question that came up in the [[php-db mailing list->http://lists.php.net/php.db]].%0aParent:(Technology.)PHP%0aIncludeMe:[[(Technology.)PHP]]%0aCategories:[[!Articles]]%0aTags: php, mysql, file uploads, table creation%0a(:tags-hide php, mysql, file uploads, table creation :)%0a>>%3c%3c%0a%0a[[#excerpt]]%0aA question[^[[http://news.php.net/php.db/48331 | Stuck trying to upload and grab file name]]^] came up about how to create and load a table from an uploaded CSV file directly from the temporary file rather than moving the temporary file to a permanent location first. This shows it can be done.%0a[[#excerptend]]%0a%0a!! The problem.%0a%0aA developer wanted to allow the user to upload a comma separated file (CSV) that contains various data they want available in a table. This is not as difficult as it seemed to be, one just needs a good understanding of how the [[MySQL @@LOAD DATA@@ -> http://dev.mysql.com/doc/refman/5.1/en/load-data.html]][^[[MySQL :: MySQL 5.1 Reference Manual :: 13.2.6 LOAD DATA INFILE Syntax-> http://dev.mysql.com/doc/refman/5.1/en/load-data.html]]^] statement works.%0a%0a!! The solution.%0a%0a!!! Example upload file%0a%0aFor the purposes of this article, we'll use the following file, @@table1.csv@@ to upload:%0a%0a[@%0aa,b,c,d,e%0af,g,h,i,j%0ak,l,m,n,o%0a@]%0a%0a!!! Given a file upload form:%0a%0a(:source lang=html4strict:)%0a%3cform enctype="multipart/form-data" method="POST">%0a    %3cinput type="hidden" name="MAX_FILE_SIZE" value="30000" />%0a    Send this file: %3cinput name="userfile" type="file"/>%0a    %3cinput type="submit" value="Send File" />%0a%3c/form>%0a(:sourceend:)%0a%0awe can see that the resulting @@$_FILES@@ array will have an entry for @@userfile@@ in it with the particulars of the file uploaded, @@table1.csv@@.%0a%0aFor the above form, when a file @@table1.csv@@ is submitted, the @@$_FILES@@ array looks like:%0a[@%0a  array(1) {%0a  ["userfile"]=>%0a    array(5) {%0a      ["name"]=>string(10) "table1.csv"%0a      ["type"]=>string(8) "text/csv"%0a      ["tmp_name"]=>string(14) "/tmp/php6jIEPm"%0a      ["error"]=>int(0)%0a      ["size"]=>int(30)%0a    }%0a  }%0a@]%0a%0a%0a!!! Check if there is a file uploaded%0a%0aBefore attempting to process files, check that there are files to process:%0a%0a(:source lang=php:)%0a   if (count($_FILES)%3c0) {%0a      // process uploaded files%0a      .%0a      .%0a      .%0a   }%0a(:sourceend:)%0a%0aAs you would if you were processing any other form submission, you should verify that the data is useful and not harmful.%0a%0a!!! Assign some working variables%0a%0aInside the if above,%0a%0a(:source lang=php:)%0a$table_name = preg_replace('/[^[:alnum:]_]+/','',$_FILES['userfile']['name']);%0a$temp_file = $_FILES['userfile']['tmp_name'];%0a(:sourceend:)%0a%0a@@userfile@@ corresponds to the field in the form above.%0a%0aNote the we munge the file name of the uploaded file (not the temporary file!) to make sure it will only contain characters valid for a MySQL table.%0a%0a!!! How many fields will be in the table?%0a%0aTo use the @@LOAD DATA@@ statement, one has to know the fields that will be going in in order to create the table correctly. To do this, one can simply read the first line off the file and split it into fields, and count them. Given this is a CSV file, that might be more difficult than it sounds, as field items can contain commas if wrapped in double quotes. However, PHP comes to our rescue with the [[fgetcsv() -> http://php.net/manual/en/function.fgetcsv.php]][^[[PHP: fgetcsv - Manual ->http://php.net/manual/en/function.fgetcsv.php]]^] function. A rather simple function will do:%0a%0a(:source lang=php:)%0afunction csv_field_count($fn) {%0a  $fh = fopen($fn,'r') or die("Could not open $fn");%0a  $line = fgetcsv($fh);%0a  fclose($fh);%0a  $count = count($line);%0a  return $count;%0a}%0a(:sourceend:)%0a%0aWe will need to create a field for each field in the CSV file. %0a%0a>>important%3c%3c%0aNote that this method '''only''' works when the first line contains the '''maximum''' number of fields that ever appear in the file, otherwise you will lose data from the CSV file (MySQL silently drops the excess data.)%0a>>%3c%3c%0a%0a!!! Creating the table%0a%0aCreating the table is now a matter of generating fields to hold the data. In this case, all data is assumed to simply be strings of undifferentiated text (i.e. no interpretation of integers, floats, and so on). Thus each field will by a @@VARCHAR@@ of length 255, which is a limit in Excel.%0a%0a(:source lang=php:)%0a$count = csv_field_count($temp_name); // call our function from above%0a$sql = 'create table if not exists `'.$table_name.'` (';%0afor ($i=0; $i %3c $count; $i++) { %0a  $sql_fields[] = "field{$i} varchar(255)";%0a}%0a// this goes last so as not to perturb any data from the CSV file%0a$sql_fields[] =   'id integer not null auto_increment primary key';%0a$sql .= implode(', ',$sql_fields);%0a$sql .= ')';%0a(:sourceend:)%0a%0aIf you want your table to have an autoincrementing index, such as shown here for field @@id@@, you need to put it '''last''' in order for it to be treated as @@NULL@@ by @@LOAD DATA@@ (and thus be autoincremented for each record).%0a%0aExecuting the above SQL statement will create a table for the CSV file that is derived from the CSV upload file name and its contents. When you run the query, ensure that no errors occured during it's execution.%0a%0a(:source lang=php:)%0a$r = $db->query($sql) or die(sprintf("SQL error: %25s [%25d] %25s",$sql,$db->errno,$db->error));%0a(:sourceend:)%0a%0aIs the idiom when using @@mysqli@@.%0a%0a!!! Loading the data.%0a%0aThe [[MySQL @@LOAD DATA@@ -> http://dev.mysql.com/doc/refman/5.1/en/load-data.html]] statement can be a little tricky. In order to get this to work easily, the main key is to use the @@LOCAL@@ option. Creating the SQL for the @@LOAD DATA@@ statement is basically:%0a%0a(:source lang=php:)%0a$sql = "load data local infile '".$temp_file."' " .%0a  "into table `".$table_name."` " .%0a  "fields terminated by ',' optionally enclosed by '\"' " .%0a  "lines terminated by '\\n'";%0a(:sourceend:)%0a%0aIf you don't use the @@local@@ option, you have to deal with MySQL's shennanigans about file permissions based on the location of the temporary file, and using @@local@@ just makes everything a lot easier. (Note that if the file is really large, though, it can be a problem as this will send the contents of the file through the mysql pipe.)%0a%0a[^#^]%0a%0a!! Working example source code%0a%0a(Note, you will need to create the database, assign permissions, and put the credentials in the source for this to work.)%0a%0a%0a(:source lang=php:)%0a%3c?php %0aerror_reporting(-1);%0aini_set('display_errors',true);%0aini_set('display_startup_errors',true);%0a%0a%0a%0a?>%3c!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">%0a%3chtml>%3chead>%3ctitle>file upload example%3c/title>%0a%3cmeta http-equiv="Content-Type" content="text/html; charset=UTF-8" />%0a%3c/head>%0a%3cbody>%0a%3ch1>file upload example%3c/h1>%0a%0a%3ch2>$_FILES%3c/h2>%0a%3cpre>%0a  %3c?php var_dump($_FILES); ?>%0a%3c/pre>%0a%0a%3c?php%0a   if (count($_FILES)>0) {%0a     $table_name = preg_replace('/[^[:alnum:]_]+/','',$_FILES['userfile']['name']);%0a     $temp_file = $_FILES['userfile']['tmp_name'];%0a%0a%0a     $lscmd = 'ls -l '.$temp_file;%0a     echo '%3ch2>ls -l '.$temp_file.'%3c/h2>'.PHP_EOL;%0a     echo '%3cpre>'.`$lscmd`.'%3c/pre>'.PHP_EOL;%0a%0a?>%0a%0a%3c?php%0a   $db = new mysqli(DBHOST,DBUSER,DBPASS,DBNAME);%0aif (mysqli_connect_errno()) {%0a  die('Connection failure: ['.mysqli_connect_errno().'] '.mysqli_connect_error());%0a}%0a%0a     $fields = explode(',',read_first_line($temp_file));%0a     $sql = 'create table if not exists `'.$table_name.'` (';%0a     for ($i=0; $i %3c count($fields); $i++) { %0a       $sql_fields[] = "field{$i} varchar(50)";%0a     }%0a     $sql_fields[] =   'id integer not null auto_increment primary key';%0a     $sql .= implode(', ',$sql_fields);%0a     $sql .= ')';%0a?>%0a%3ch2>$sql for create table%3c/h2>%0a%3cpre>%3c?php var_dump($sql); ?>%3c/pre>%0a%0a%3c?php%0a     $r = $db->query($sql) or die("SQL error: $sql [".$db->errno.'] '.$db->error);%0a     unset($sql);%0a%0a$sql = "load data local infile '".$temp_file."' " .%0a  "into table `".$table_name."` " .%0a  "fields terminated by ',' optionally enclosed by '\"' " .%0a  "lines terminated by '\\n'";%0a?>%0a%3ch2>$sql for load data%3c/h2>%0a%3cpre>%3c?php var_dump($sql); ?>%3c/pre>%0a%3c?php%0a     $r = $db->query($sql) or die("SQL Error: $sql [".$db->errno."] ".$db->error);%0a?>%0a%0a%3ch2>Verify data contents%3c/h2>%0a     %3cp>Table %3c?php echo $table_name; ?>%3c/p>%0a%0a%3c?php%0a     unset($sql);%0a     $sql = 'select * from `'.$table_name.'`';%0a     echo '%3cpre>$sql=';%0a     var_dump($sql);%0a     echo '%3c/pre>';%0a     $r = $db->query($sql) or die("SQL Error: $sql [".$db->errno."] ".$db->error);%0a     echo '%3cp>data%3c/p>%3cpre>';%0a     while ($row = $r->fetch_row()) {%0a       echo var_dump($row);%0a     }%0a     echo '%3c/pre>';%0a?>%0a%0a     %3c?php } // end if count($_FILES)>0 ?>%0a%0a%3cform enctype="multipart/form-data" method="POST">%0a    %3cinput type="hidden" name="MAX_FILE_SIZE" value="30000" />%0a    Send this file: %3cinput name="userfile" type="file"/>%0a    %3cinput type="submit" value="Send File" />%0a%3c/form>%0a%0a%3c/body>%0a%3c/html>%3c?php%0a%0afunction csv_field_count($fn) {%0a  $fh = fopen($fn,'r') or die("Could not open $fn");%0a  $line = fgetcsv($fh);%0a  fclose($fh);%0a  $count = count($line);%0a  return $count;%0a}%0a%0a%0a(:sourceend:)%0a%0a!! TODO%0a%0a* Verify data truncation if 2-n lines of the CSV file contain more fields than the first line.%0a* Ensure that the file uploaded is a CSV file.%0a* Ensure that the file name won't otherwise corrupt the MySQL data base.%0a* If the table already exists, decide what to do (truncate and load, replace, append, fail and inform).%0a* Verify that field data that exceeds the field length is truncated and does not produce an error.%0a
time=1343367592
author:1343367592=tamara
csum:1343367592=add references
diff:1343367592:1343365945:=2c2%0a%3c Summary:A solution to a question that came up in the [[php-db mailing list->http://lists.php.net/php.db]].%0a---%0a> Summary:A solution to a question that came up in the php mailing list.%0a11c11%0a%3c A question[^[[http://news.php.net/php.db/48331 | Stuck trying to upload and grab file name]]^] came up about how to create and load a table from an uploaded CSV file directly from the temporary file rather than moving the temporary file to a permanent location first. This shows it can be done.%0a---%0a> A question came up about how to create and load a table from an uploaded CSV file directly from the temporary file rather than moving the temporary file to a permanent location first. This shows it can be done.%0a16,17c16,17%0a%3c A developer wanted to allow the user to upload a comma separated file (CSV) that contains various data they want available in a table. This is not as difficult as it seemed to be, one just needs a good understanding of how the [[MySQL @@LOAD DATA@@ -> http://dev.mysql.com/doc/refman/5.1/en/load-data.html]][^[[MySQL :: MySQL 5.1 Reference Manual :: 13.2.6 LOAD DATA INFILE Syntax-> http://dev.mysql.com/doc/refman/5.1/en/load-data.html]]^] statement works.%0a%3c %0a---%0a> A developer wanted to allow the user to upload a comma separated file (CSV) that contains various data they want available in a table. This is not as difficult as it seemed to be, one just needs a good understanding of how the @@LOAD DATA@@ MySQL statement works.%0a> %0a87,88c87,88%0a%3c To use the @@LOAD DATA@@ statement, one has to know the fields that will be going in in order to create the table correctly. To do this, one can simply read the first line off the file and split it into fields, and count them. Given this is a CSV file, that might be more difficult than it sounds, as field items can contain commas if wrapped in double quotes. However, PHP comes to our rescue with the [[fgetcsv() -> http://php.net/manual/en/function.fgetcsv.php]][^[[PHP: fgetcsv - Manual ->http://php.net/manual/en/function.fgetcsv.php]]^] function. A rather simple function will do:%0a%3c %0a---%0a> To use the @@LOAD DATA@@ statement, one has to know the fields that will be going in in order to create the table correctly. To do this, one can simply read the first line off the file and split it into fields, and count them. Given this is a CSV file, that might be more difficult than it sounds, as field items can contain commas if wrapped in double quotes. However, PHP comes to our rescue with the [[fgetcsv() -> http://php.net/manual/en/function.fgetcsv.php]] function. A rather simple function will do:%0a> %0a144,145d143%0a%3c [^#^]%0a%3c %0a148,150d145%0a%3c (Note, you will need to create the database, assign permissions, and put the credentials in the source for this to work.)%0a%3c %0a%3c %0a184c179%0a%3c    $db = new mysqli(DBHOST,DBUSER,DBPASS,DBNAME);%0a---%0a>    $db = new mysqli('localhost','test','testpw','testfileupload');%0a255,261c250%0a%3c !! TODO%0a%3c %0a%3c * Verify data truncation if 2-n lines of the CSV file contain more fields than the first line.%0a%3c * Ensure that the file uploaded is a CSV file.%0a%3c * Ensure that the file name won't otherwise corrupt the MySQL data base.%0a%3c * If the table already exists, decide what to do (truncate and load, replace, append, fail and inform).%0a%3c * Verify that field data that exceeds the field length is truncated and does not produce an error.%0a---%0a> (Note, you will need to create the database and assign permissions for this to work.)%0a
host:1343367592=71.63.211.0
author:1343365945=tamara
diff:1343365945:1343365348:=59,60d58%0a%3c Before attempting to process files, check that there are files to process:%0a%3c %0a70,71d67%0a%3c As you would if you were processing any other form submission, you should verify that the data is useful and not harmful.%0a%3c %0a77,78c73,74%0a%3c $table_name = preg_replace('/[^[:alnum:]_]+/','',$_FILES['userfile']['name']);%0a%3c $temp_file = $_FILES['userfile']['tmp_name'];%0a---%0a>      $table_name = preg_replace('/[^[:alnum:]_]+/','',$_FILES['userfile']['name']);%0a>      $temp_file = $_FILES['userfile']['tmp_name'];%0a99,100c95,96%0a%3c We will need to create a field for each field in the CSV file. %0a%3c %0a---%0a> We need to create a field for each field in the CSV file. %0a> %0a107,108c103,104%0a%3c Creating the table is now a matter of generating fields to hold the data. In this case, all data is assumed to simply be strings of undifferentiated text (i.e. no interpretation of integers, floats, and so on). Thus each field will by a @@VARCHAR@@ of length 255, which is a limit in Excel.%0a%3c %0a---%0a> Creating the table is simple now a matter of generating fields to hold the data. In this case, all data is assumed to simply be strings of undifferentiated text (i.e. no interpretation of integers, floats, and so on). Thus each field will by a @@VARCHAR@@ of length 255, which is a limit in Excel.%0a> %0a110c106%0a%3c $count = csv_field_count($temp_name); // call our function from above%0a---%0a> $count = csv_field_count($temp_name);%0a115d110%0a%3c // this goes last so as not to perturb any data from the CSV file%0a123,129c118%0a%3c Executing the above SQL statement will create a table for the CSV file that is derived from the CSV upload file name and its contents. When you run the query, ensure that no errors occured during it's execution.%0a%3c %0a%3c (:source lang=php:)%0a%3c $r = $db->query($sql) or die(sprintf("SQL error: %25s [%25d] %25s",$sql,$db->errno,$db->error));%0a%3c (:sourceend:)%0a%3c %0a%3c Is the idiom when using @@mysqli@@.%0a---%0a> Executing the above SQL statement will create a table for the CSV file that is derived from the CSV upload file name and its contents.%0a
host:1343365945=71.63.211.0
author:1343365348=tamara
csum:1343365348=new article
diff:1343365348:1343365348:=1,239d0%0a%3c >>comment%3c%3c%0a%3c Summary:A solution to a question that came up in the php mailing list.%0a%3c Parent:(Technology.)PHP%0a%3c IncludeMe:[[(Technology.)PHP]]%0a%3c Categories:[[!Articles]]%0a%3c Tags: php, mysql, file uploads, table creation%0a%3c (:tags-hide php, mysql, file uploads, table creation :)%0a%3c >>%3c%3c%0a%3c %0a%3c [[#excerpt]]%0a%3c A question came up about how to create and load a table from an uploaded CSV file directly from the temporary file rather than moving the temporary file to a permanent location first. This shows it can be done.%0a%3c [[#excerptend]]%0a%3c %0a%3c !! The problem.%0a%3c %0a%3c A developer wanted to allow the user to upload a comma separated file (CSV) that contains various data they want available in a table. This is not as difficult as it seemed to be, one just needs a good understanding of how the @@LOAD DATA@@ MySQL statement works.%0a%3c %0a%3c !! The solution.%0a%3c %0a%3c !!! Example upload file%0a%3c %0a%3c For the purposes of this article, we'll use the following file, @@table1.csv@@ to upload:%0a%3c %0a%3c [@%0a%3c a,b,c,d,e%0a%3c f,g,h,i,j%0a%3c k,l,m,n,o%0a%3c @]%0a%3c %0a%3c !!! Given a file upload form:%0a%3c %0a%3c (:source lang=html4strict:)%0a%3c %3cform enctype="multipart/form-data" method="POST">%0a%3c     %3cinput type="hidden" name="MAX_FILE_SIZE" value="30000" />%0a%3c     Send this file: %3cinput name="userfile" type="file"/>%0a%3c     %3cinput type="submit" value="Send File" />%0a%3c %3c/form>%0a%3c (:sourceend:)%0a%3c %0a%3c we can see that the resulting @@$_FILES@@ array will have an entry for @@userfile@@ in it with the particulars of the file uploaded, @@table1.csv@@.%0a%3c %0a%3c For the above form, when a file @@table1.csv@@ is submitted, the @@$_FILES@@ array looks like:%0a%3c [@%0a%3c   array(1) {%0a%3c   ["userfile"]=>%0a%3c     array(5) {%0a%3c       ["name"]=>string(10) "table1.csv"%0a%3c       ["type"]=>string(8) "text/csv"%0a%3c       ["tmp_name"]=>string(14) "/tmp/php6jIEPm"%0a%3c       ["error"]=>int(0)%0a%3c       ["size"]=>int(30)%0a%3c     }%0a%3c   }%0a%3c @]%0a%3c %0a%3c %0a%3c !!! Check if there is a file uploaded%0a%3c %0a%3c (:source lang=php:)%0a%3c    if (count($_FILES)%3c0) {%0a%3c       // process uploaded files%0a%3c       .%0a%3c       .%0a%3c       .%0a%3c    }%0a%3c (:sourceend:)%0a%3c %0a%3c !!! Assign some working variables%0a%3c %0a%3c Inside the if above,%0a%3c %0a%3c (:source lang=php:)%0a%3c      $table_name = preg_replace('/[^[:alnum:]_]+/','',$_FILES['userfile']['name']);%0a%3c      $temp_file = $_FILES['userfile']['tmp_name'];%0a%3c (:sourceend:)%0a%3c %0a%3c @@userfile@@ corresponds to the field in the form above.%0a%3c %0a%3c Note the we munge the file name of the uploaded file (not the temporary file!) to make sure it will only contain characters valid for a MySQL table.%0a%3c %0a%3c !!! How many fields will be in the table?%0a%3c %0a%3c To use the @@LOAD DATA@@ statement, one has to know the fields that will be going in in order to create the table correctly. To do this, one can simply read the first line off the file and split it into fields, and count them. Given this is a CSV file, that might be more difficult than it sounds, as field items can contain commas if wrapped in double quotes. However, PHP comes to our rescue with the [[fgetcsv() -> http://php.net/manual/en/function.fgetcsv.php]] function. A rather simple function will do:%0a%3c %0a%3c (:source lang=php:)%0a%3c function csv_field_count($fn) {%0a%3c   $fh = fopen($fn,'r') or die("Could not open $fn");%0a%3c   $line = fgetcsv($fh);%0a%3c   fclose($fh);%0a%3c   $count = count($line);%0a%3c   return $count;%0a%3c }%0a%3c (:sourceend:)%0a%3c %0a%3c We need to create a field for each field in the CSV file. %0a%3c %0a%3c >>important%3c%3c%0a%3c Note that this method '''only''' works when the first line contains the '''maximum''' number of fields that ever appear in the file, otherwise you will lose data from the CSV file (MySQL silently drops the excess data.)%0a%3c >>%3c%3c%0a%3c %0a%3c !!! Creating the table%0a%3c %0a%3c Creating the table is simple now a matter of generating fields to hold the data. In this case, all data is assumed to simply be strings of undifferentiated text (i.e. no interpretation of integers, floats, and so on). Thus each field will by a @@VARCHAR@@ of length 255, which is a limit in Excel.%0a%3c %0a%3c (:source lang=php:)%0a%3c $count = csv_field_count($temp_name);%0a%3c $sql = 'create table if not exists `'.$table_name.'` (';%0a%3c for ($i=0; $i %3c $count; $i++) { %0a%3c   $sql_fields[] = "field{$i} varchar(255)";%0a%3c }%0a%3c $sql_fields[] =   'id integer not null auto_increment primary key';%0a%3c $sql .= implode(', ',$sql_fields);%0a%3c $sql .= ')';%0a%3c (:sourceend:)%0a%3c %0a%3c If you want your table to have an autoincrementing index, such as shown here for field @@id@@, you need to put it '''last''' in order for it to be treated as @@NULL@@ by @@LOAD DATA@@ (and thus be autoincremented for each record).%0a%3c %0a%3c Executing the above SQL statement will create a table for the CSV file that is derived from the CSV upload file name and its contents.%0a%3c %0a%3c !!! Loading the data.%0a%3c %0a%3c The [[MySQL @@LOAD DATA@@ -> http://dev.mysql.com/doc/refman/5.1/en/load-data.html]] statement can be a little tricky. In order to get this to work easily, the main key is to use the @@LOCAL@@ option. Creating the SQL for the @@LOAD DATA@@ statement is basically:%0a%3c %0a%3c (:source lang=php:)%0a%3c $sql = "load data local infile '".$temp_file."' " .%0a%3c   "into table `".$table_name."` " .%0a%3c   "fields terminated by ',' optionally enclosed by '\"' " .%0a%3c   "lines terminated by '\\n'";%0a%3c (:sourceend:)%0a%3c %0a%3c If you don't use the @@local@@ option, you have to deal with MySQL's shennanigans about file permissions based on the location of the temporary file, and using @@local@@ just makes everything a lot easier. (Note that if the file is really large, though, it can be a problem as this will send the contents of the file through the mysql pipe.)%0a%3c %0a%3c !! Working example source code%0a%3c %0a%3c (:source lang=php:)%0a%3c %3c?php %0a%3c error_reporting(-1);%0a%3c ini_set('display_errors',true);%0a%3c ini_set('display_startup_errors',true);%0a%3c %0a%3c %0a%3c %0a%3c ?>%3c!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">%0a%3c %3chtml>%3chead>%3ctitle>file upload example%3c/title>%0a%3c %3cmeta http-equiv="Content-Type" content="text/html; charset=UTF-8" />%0a%3c %3c/head>%0a%3c %3cbody>%0a%3c %3ch1>file upload example%3c/h1>%0a%3c %0a%3c %3ch2>$_FILES%3c/h2>%0a%3c %3cpre>%0a%3c   %3c?php var_dump($_FILES); ?>%0a%3c %3c/pre>%0a%3c %0a%3c %3c?php%0a%3c    if (count($_FILES)>0) {%0a%3c      $table_name = preg_replace('/[^[:alnum:]_]+/','',$_FILES['userfile']['name']);%0a%3c      $temp_file = $_FILES['userfile']['tmp_name'];%0a%3c %0a%3c %0a%3c      $lscmd = 'ls -l '.$temp_file;%0a%3c      echo '%3ch2>ls -l '.$temp_file.'%3c/h2>'.PHP_EOL;%0a%3c      echo '%3cpre>'.`$lscmd`.'%3c/pre>'.PHP_EOL;%0a%3c %0a%3c ?>%0a%3c %0a%3c %3c?php%0a%3c    $db = new mysqli('localhost','test','testpw','testfileupload');%0a%3c if (mysqli_connect_errno()) {%0a%3c   die('Connection failure: ['.mysqli_connect_errno().'] '.mysqli_connect_error());%0a%3c }%0a%3c %0a%3c      $fields = explode(',',read_first_line($temp_file));%0a%3c      $sql = 'create table if not exists `'.$table_name.'` (';%0a%3c      for ($i=0; $i %3c count($fields); $i++) { %0a%3c        $sql_fields[] = "field{$i} varchar(50)";%0a%3c      }%0a%3c      $sql_fields[] =   'id integer not null auto_increment primary key';%0a%3c      $sql .= implode(', ',$sql_fields);%0a%3c      $sql .= ')';%0a%3c ?>%0a%3c %3ch2>$sql for create table%3c/h2>%0a%3c %3cpre>%3c?php var_dump($sql); ?>%3c/pre>%0a%3c %0a%3c %3c?php%0a%3c      $r = $db->query($sql) or die("SQL error: $sql [".$db->errno.'] '.$db->error);%0a%3c      unset($sql);%0a%3c %0a%3c $sql = "load data local infile '".$temp_file."' " .%0a%3c   "into table `".$table_name."` " .%0a%3c   "fields terminated by ',' optionally enclosed by '\"' " .%0a%3c   "lines terminated by '\\n'";%0a%3c ?>%0a%3c %3ch2>$sql for load data%3c/h2>%0a%3c %3cpre>%3c?php var_dump($sql); ?>%3c/pre>%0a%3c %3c?php%0a%3c      $r = $db->query($sql) or die("SQL Error: $sql [".$db->errno."] ".$db->error);%0a%3c ?>%0a%3c %0a%3c %3ch2>Verify data contents%3c/h2>%0a%3c      %3cp>Table %3c?php echo $table_name; ?>%3c/p>%0a%3c %0a%3c %3c?php%0a%3c      unset($sql);%0a%3c      $sql = 'select * from `'.$table_name.'`';%0a%3c      echo '%3cpre>$sql=';%0a%3c      var_dump($sql);%0a%3c      echo '%3c/pre>';%0a%3c      $r = $db->query($sql) or die("SQL Error: $sql [".$db->errno."] ".$db->error);%0a%3c      echo '%3cp>data%3c/p>%3cpre>';%0a%3c      while ($row = $r->fetch_row()) {%0a%3c        echo var_dump($row);%0a%3c      }%0a%3c      echo '%3c/pre>';%0a%3c ?>%0a%3c %0a%3c      %3c?php } // end if count($_FILES)>0 ?>%0a%3c %0a%3c %3cform enctype="multipart/form-data" method="POST">%0a%3c     %3cinput type="hidden" name="MAX_FILE_SIZE" value="30000" />%0a%3c     Send this file: %3cinput name="userfile" type="file"/>%0a%3c     %3cinput type="submit" value="Send File" />%0a%3c %3c/form>%0a%3c %0a%3c %3c/body>%0a%3c %3c/html>%3c?php%0a%3c %0a%3c function csv_field_count($fn) {%0a%3c   $fh = fopen($fn,'r') or die("Could not open $fn");%0a%3c   $line = fgetcsv($fh);%0a%3c   fclose($fh);%0a%3c   $count = count($line);%0a%3c   return $count;%0a%3c }%0a%3c %0a%3c %0a%3c (:sourceend:)%0a%3c %0a%3c (Note, you will need to create the database and assign permissions for this to work.)%0a
host:1343365348=71.63.211.0
